name: Test Suite

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run nightly at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  type-checking:
    name: Type Safety & Schema Validation
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install mypy types-python-jose types-passlib

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Python type checking with mypy
        run: |
          echo "ðŸ” Running Python type checking..."
          mypy api/ --config-file mypy.ini || {
            echo "âŒ Python type checking failed"
            echo "There are type errors in the backend code."
            exit 1
          }

      - name: Generate OpenAPI spec
        run: |
          echo "ðŸ“ Generating OpenAPI specification..."
          python scripts/generate_openapi_spec.py --output api-spec.json

      - name: Generate TypeScript types
        working-directory: ./frontend
        run: |
          echo "ðŸ”„ Generating TypeScript types from OpenAPI spec..."
          npm run generate:types:local

      - name: Validate type synchronization
        run: |
          echo "ðŸ” Validating type synchronization..."
          if git diff --exit-code frontend/src/types/api-generated.ts > /dev/null 2>&1; then
            echo "âœ… TypeScript types are synchronized with backend schemas"
          else
            echo "âŒ TypeScript types are OUT OF SYNC with backend schemas!"
            echo "The generated types differ from committed types."
            echo ""
            echo "Changes detected:"
            git diff frontend/src/types/api-generated.ts
            echo ""
            echo "To fix this, run: ./scripts/regenerate-types.sh --local"
            echo "Then commit the updated types file."
            exit 1
          fi

      - name: TypeScript type checking
        working-directory: ./frontend
        run: |
          echo "ðŸ” Running TypeScript type checking..."
          npm run type-check || {
            echo "âŒ TypeScript compilation failed"
            echo "There are type errors in the frontend code."
            exit 1
          }

      - name: Upload OpenAPI spec as artifact
        uses: actions/upload-artifact@v3
        with:
          name: openapi-spec
          path: api-spec.json

  api-tests:
    name: API Integration Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: narra_forge
          POSTGRES_PASSWORD: narra_forge
          POSTGRES_DB: narra_forge_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-test.txt

      - name: Run API integration tests
        env:
          DATABASE_URL: postgresql://narra_forge:narra_forge@localhost:5432/narra_forge_test
          JWT_SECRET_KEY: test-secret-key-for-ci
          REDIS_URL: redis://localhost:6379/0
        run: |
          pytest tests/api/ -v --cov=api --cov-report=xml --cov-report=html

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: api-tests

  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: narra_forge
          POSTGRES_PASSWORD: narra_forge
          POSTGRES_DB: narra_forge
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Install Playwright
        working-directory: ./frontend
        run: npx playwright install --with-deps chromium

      - name: Start backend
        env:
          DATABASE_URL: postgresql://narra_forge:narra_forge@localhost:5432/narra_forge
          JWT_SECRET_KEY: test-secret-key-for-ci
        run: |
          uvicorn api.main:app --host 0.0.0.0 --port 8000 &
          sleep 10

      - name: Run E2E tests
        working-directory: ./frontend
        env:
          BASE_URL: http://localhost:3000
          NEXT_PUBLIC_API_URL: http://localhost:8000
        run: npm test

      - name: Upload Playwright Report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: playwright-report
          path: frontend/playwright-report/
