services:
  narra-forge:
    build:
      context: .
      dockerfile: Dockerfile
    image: narra-forge:latest
    container_name: narra-forge-app

    # Przekaż zmienne środowiskowe
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}

    # Montuj volumes dla persystencji
    volumes:
      - ./data:/app/data
      - ./output:/app/output
      - ./logs:/app/logs

    # Restart policy
    restart: unless-stopped

    # Komenda (można override)
    command: python -u test_docker.py

  # FastAPI Server
  narra-forge-api:
    build:
      context: .
      dockerfile: Dockerfile
    image: narra-forge:latest
    container_name: narra-forge-api

    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}

    volumes:
      - ./data:/app/data
      - ./output:/app/output
      - ./logs:/app/logs

    ports:
      - "8000:8000"

    restart: unless-stopped

    command: uvicorn narra_forge.api.server:app --host 0.0.0.0 --port 8000 --reload

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Streamlit UI
  narra-forge-ui:
    build:
      context: .
      dockerfile: Dockerfile
    image: narra-forge:latest
    container_name: narra-forge-ui

    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}

    volumes:
      - ./data:/app/data
      - ./output:/app/output
      - ./logs:/app/logs

    ports:
      - "8501:8501"

    restart: unless-stopped

    command: streamlit run narra_forge/ui/streamlit_app.py --server.port=8501 --server.address=0.0.0.0

    depends_on:
      - narra-forge-api

  # Opcjonalny serwis dla interaktywnej pracy
  narra-forge-dev:
    build:
      context: .
      dockerfile: Dockerfile
    image: narra-forge:latest
    container_name: narra-forge-dev

    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}

    volumes:
      - ./data:/app/data
      - ./output:/app/output
      - ./logs:/app/logs
      - .:/app  # Mount całego kodu dla development

    # Tryb interaktywny
    stdin_open: true
    tty: true

    # Override domyślnej komendy
    command: /bin/bash

    profiles:
      - dev
