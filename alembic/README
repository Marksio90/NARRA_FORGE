# NARRA_FORGE Database Migrations

This directory contains Alembic migrations for the NARRA_FORGE database.

## Setup

1. Create PostgreSQL database:
```bash
createdb narra_forge
```

2. Set environment variables:
```bash
export DB_USER=narra_forge
export DB_PASSWORD=your_password
export DB_HOST=localhost
export DB_PORT=5432
export DB_NAME=narra_forge
```

## Usage

### Create a new migration

```bash
# Auto-generate migration from model changes
alembic revision --autogenerate -m "Add user table"

# Create empty migration
alembic revision -m "Custom migration"
```

### Apply migrations

```bash
# Upgrade to latest
alembic upgrade head

# Upgrade one version
alembic upgrade +1

# Downgrade one version
alembic downgrade -1

# Downgrade to base
alembic downgrade base
```

### Check migration status

```bash
# Show current revision
alembic current

# Show migration history
alembic history

# Show pending migrations
alembic heads
```

## Initial Migration

The initial migration creates all tables:
- users
- projects
- generation_jobs
- narratives
- usage_logs

## Migration Workflow

1. Make changes to models in `api/models/`
2. Generate migration: `alembic revision --autogenerate -m "description"`
3. Review generated migration in `alembic/versions/`
4. Apply migration: `alembic upgrade head`
5. Test changes
6. Commit migration file to git

## Troubleshooting

### Database connection error

Check your environment variables and ensure PostgreSQL is running.

### Migration conflicts

If you have multiple migration heads:
```bash
alembic merge heads -m "merge migrations"
```

### Reset database

```bash
alembic downgrade base
dropdb narra_forge
createdb narra_forge
alembic upgrade head
```
